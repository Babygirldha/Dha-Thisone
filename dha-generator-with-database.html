<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHA Document Generator with Database Integration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #005a3c, #ffd700);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .coat-of-arms {
            font-size: 80px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        h1 {
            color: #005a3c;
            font-size: 32px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .subtitle {
            color: #666;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .verification-link {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #005a3c;
        }
        
        .verification-link h3 {
            color: #005a3c;
            margin-bottom: 10px;
        }
        
        .verification-link a {
            color: #005a3c;
            font-weight: bold;
            font-size: 18px;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .document-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 5px solid #005a3c;
            transition: all 0.3s;
        }
        
        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .document-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .document-title {
            color: #005a3c;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .document-name {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .verification-code {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            color: #d32f2f;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .db-status {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .db-status.saved {
            color: #28a745;
            font-weight: bold;
        }
        
        .download-btn {
            background: #005a3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .download-btn:hover {
            background: #007850;
            transform: translateY(-2px);
        }
        
        .download-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        
        .sync-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .sync-btn {
            background: linear-gradient(135deg, #005a3c, #007850);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 90, 60, 0.4);
        }
        
        .sync-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            display: block;
        }
        
        .hidden-qr {
            display: none;
        }
        
        #barcodeCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="coat-of-arms">ü¶Ö</div>
            <h1>Department of Home Affairs</h1>
            <div class="subtitle">Republic of South Africa</div>
            <div class="subtitle" style="color: #888; font-size: 14px;">Document Generator with Database Integration</div>
            <div class="status-badge">‚úì Connected to DHA Database</div>
            
            <div class="verification-link">
                <h3>üîç Verify Documents Online</h3>
                <p>Visit the official verification portal:</p>
                <a href="verification.html" target="_blank">verification.html</a>
            </div>
        </div>

        <!-- Sync Section -->
        <div class="sync-section">
            <h2 style="color: #005a3c; margin-bottom: 20px;">Database Synchronization</h2>
            <p style="color: #666; margin-bottom: 20px;">Save all 11 documents to the permanent database</p>
            <button class="sync-btn" id="syncBtn" onclick="syncToDatabase()">
                <span>üíæ</span>
                <span>SYNC ALL TO DATABASE</span>
            </button>
            <div class="status-message" id="syncStatus"></div>
        </div>

        <!-- Documents Grid -->
        <div class="documents-grid" id="documentsGrid">
            <!-- Documents will be dynamically generated here -->
        </div>
    </div>

    <!-- Hidden elements for QR and Barcode -->
    <div id="qrcode" class="hidden-qr"></div>
    <canvas id="barcodeCanvas"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        
        // Documents data array
        const documents = [
            { 
                id: 1, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'MUHAMMAD MOHSIN', 
                code: 'DHA-2025-10001', 
                passport: 'AD0116281', 
                nationality: 'PAKISTANI',
                dob: '15 May 2018',
                gender: 'Male',
                placeOfBirth: 'Pakistan',
                saved: false
            },
            { 
                id: 2, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'TASLEEM MOHSIN', 
                code: 'DHA-2025-10002', 
                passport: 'AUD115281', 
                nationality: 'PAKISTANI',
                dob: '01 Jan 1987',
                gender: 'Female',
                placeOfBirth: 'Hyderabad, Pakistan',
                saved: false
            },
            { 
                id: 3, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'KHUNSHA', 
                code: 'DHA-2025-10003', 
                passport: 'KV4122911', 
                nationality: 'PAKISTANI',
                dob: '23 Aug 2005',
                gender: 'Female',
                placeOfBirth: 'Lahore, Pakistan',
                idNumber: '35202-2423291-0',
                saved: false
            },
            { 
                id: 4, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'HAROON', 
                code: 'DHA-2025-10004', 
                passport: 'DT9840361', 
                nationality: 'PAKISTANI',
                dob: '11 Nov 2002',
                gender: 'Male',
                placeOfBirth: 'Lahore, Pakistan',
                idNumber: '35202-5214036-3',
                saved: false
            },
            { 
                id: 5, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'FAISAL', 
                code: 'DHA-2025-10005', 
                passport: 'MD3535005', 
                nationality: 'PAKISTANI',
                dob: '19 Jan 1995',
                gender: 'Male',
                placeOfBirth: 'Karachi, Pakistan',
                saved: false
            },
            { 
                id: 6, 
                type: 'PERMANENT RESIDENCE PERMIT', 
                name: 'MUHAMMAD HASNAIN YOUNIS', 
                code: 'DHA-2025-10006', 
                passport: 'CH6961586', 
                nationality: 'PAKISTANI',
                dob: '22 Jul 1986',
                gender: 'Male',
                placeOfBirth: 'Punjab, Pakistan',
                idNumber: '37405-6961586-3',
                saved: false
            },
            { 
                id: 7, 
                type: 'NATURALISATION CERTIFICATE', 
                name: 'ANNA MUNAF', 
                code: 'DHA-2025-20001', 
                previousNationality: 'PAKISTANI',
                idNumber: '850825 1583 187',
                dob: '25 Aug 1985',
                citizenshipDate: '01 Jan 2025',
                saved: false
            },
            { 
                id: 8, 
                type: 'WORK PERMIT', 
                name: 'IKRAM IBRAHIM YUSUF MANSURI', 
                code: 'DHA-2025-30001', 
                passport: '10611952',
                nationality: 'INDIAN',
                employer: 'Head Office',
                position: 'General Worker',
                sector: 'Category mentioned above',
                referenceNumber: 'JHB 76298/2025/WPVC',
                saved: false
            },
            { 
                id: 9, 
                type: 'RELATIVE VISA', 
                name: 'ANISAH', 
                code: 'DHA-2025-40001', 
                passport: 'PK8976543',
                nationality: 'PAKISTANI',
                relationship: 'Daughter',
                sponsor: 'Tasleem Mohsin',
                sponsorID: 'PR/2025/10002',
                saved: false
            },
            { 
                id: 10, 
                type: 'REFUGEE PERMIT', 
                name: 'FAATI ABDURAAM', 
                code: 'DHA-2025-50001', 
                refugeeNumber: 'PT4E000002015',
                country: 'Somalia',
                status: 'RECOGNIZED REFUGEE',
                saved: false
            },
            { 
                id: 11, 
                type: 'BIRTH CERTIFICATE', 
                name: 'ZANEERAH ALLY', 
                code: 'DHA-2025-60001', 
                dob: '21 Mar 2014',
                mother: 'Shera Ally',
                father: 'Not Provided',
                hospital: 'Linkwood Hospital',
                birthNumber: 'BC2014/0321/001',
                saved: false
            }
        ];
        
        // Initialize document cards
        function initializeDocuments() {
            const grid = document.getElementById('documentsGrid');
            grid.innerHTML = '';
            
            documents.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                card.innerHTML = `
                    <div class="document-icon">üìã</div>
                    <div class="document-title">${doc.type}</div>
                    <div class="document-name">${doc.name}</div>
                    <div class="verification-code">${doc.code}</div>
                    <div class="db-status ${doc.saved ? 'saved' : ''}" id="status-${doc.id}">
                        ${doc.saved ? '‚úÖ Saved to Database' : '‚è≥ Not in Database'}
                    </div>
                    <button class="download-btn" onclick="generateDocument(${doc.id})">
                        üì• Generate PDF
                    </button>
                    <button class="download-btn" onclick="saveToDatabase(${doc.id})" id="save-btn-${doc.id}">
                        üíæ Save to Database
                    </button>
                `;
                grid.appendChild(card);
            });
        }
        
        // Mock API call to save to database
        async function saveToDatabase(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;
            
            const saveBtn = document.getElementById(`save-btn-${docId}`);
            const statusEl = document.getElementById(`status-${docId}`);
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // In a real implementation, this would call:
            // await fetch('/api/dha/documents/generate', { method: 'POST', body: JSON.stringify(doc) })
            
            doc.saved = true;
            statusEl.className = 'db-status saved';
            statusEl.textContent = '‚úÖ Saved to Database';
            saveBtn.textContent = '‚úì Saved';
            
            // Store in localStorage as backup
            const savedDocs = JSON.parse(localStorage.getItem('dha_documents') || '[]');
            if (!savedDocs.find(s => s.code === doc.code)) {
                savedDocs.push(doc);
                localStorage.setItem('dha_documents', JSON.stringify(savedDocs));
            }
        }
        
        // Sync all documents to database
        async function syncToDatabase() {
            const syncBtn = document.getElementById('syncBtn');
            const statusMsg = document.getElementById('syncStatus');
            
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span>‚è≥</span><span>SYNCING...</span>';
            statusMsg.className = 'status-message';
            statusMsg.textContent = 'Synchronizing documents to database...';
            statusMsg.style.display = 'block';
            
            let savedCount = 0;
            for (const doc of documents) {
                if (!doc.saved) {
                    await saveToDatabase(doc.id);
                    savedCount++;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            syncBtn.disabled = false;
            syncBtn.innerHTML = '<span>‚úÖ</span><span>SYNC COMPLETE</span>';
            statusMsg.className = 'status-message success';
            statusMsg.textContent = savedCount > 0 
                ? `‚úÖ Successfully saved ${savedCount} documents to database!`
                : '‚úÖ All documents are already in the database!';
        }
        
        // Generate QR Code
        async function generateQRCode(data) {
            return new Promise((resolve) => {
                const qrDiv = document.getElementById('qrcode');
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, {
                    text: data,
                    width: 150,
                    height: 150,
                    correctLevel: QRCode.CorrectLevel.H
                });
                setTimeout(() => {
                    const canvas = qrDiv.querySelector('canvas');
                    if (canvas) {
                        resolve(canvas.toDataURL());
                    }
                }, 100);
            });
        }
        
        // Generate document (simplified version)
        async function generateDocument(docId) {
            const docData = documents.find(d => d.id === docId);
            if (!docData) return;
            
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(30);
            doc.text('ü¶Ö', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('REPUBLIC OF SOUTH AFRICA', 105, 30, { align: 'center' });
            doc.setFontSize(12);
            doc.text('DEPARTMENT OF HOME AFFAIRS', 105, 37, { align: 'center' });
            
            // Add document type
            doc.setFontSize(16);
            doc.text(docData.type, 105, 50, { align: 'center' });
            
            // Add document details
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${docData.name}`, 20, 70);
            doc.text(`Verification Code: ${docData.code}`, 20, 80);
            doc.text(`Issue Date: ${new Date().toLocaleDateString('en-GB')}`, 20, 90);
            
            if (docData.passport) {
                doc.text(`Passport: ${docData.passport}`, 20, 100);
            }
            if (docData.nationality) {
                doc.text(`Nationality: ${docData.nationality}`, 20, 110);
            }
            
            // Add QR code
            const qrData = `DHA-VERIFY:${docData.code}|${docData.name}|${docData.type}|VALID`;
            const qrCodeDataUrl = await generateQRCode(qrData);
            if (qrCodeDataUrl) {
                doc.addImage(qrCodeDataUrl, 'PNG', 150, 70, 40, 40);
            }
            
            // Add verification note
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('VERIFICATION', 20, 130);
            doc.setFont(undefined, 'normal');
            doc.text('This document can be verified at:', 20, 140);
            doc.text('verification.html', 20, 147);
            doc.text(`Using code: ${docData.code}`, 20, 154);
            
            // Add footer
            doc.setFontSize(9);
            doc.text('¬© 2025 Department of Home Affairs', 105, 280, { align: 'center' });
            
            // Save the PDF
            doc.save(`${docData.code}_${docData.name.replace(/\s+/g, '_')}.pdf`);
            
            // Automatically save to database after generation
            if (!docData.saved) {
                await saveToDatabase(docId);
            }
        }
        
        // Initialize on page load
        initializeDocuments();
        
        // Load saved status from localStorage
        const savedDocs = JSON.parse(localStorage.getItem('dha_documents') || '[]');
        savedDocs.forEach(saved => {
            const doc = documents.find(d => d.code === saved.code);
            if (doc) {
                doc.saved = true;
            }
        });
        initializeDocuments();
    </script>
</body>
</html>